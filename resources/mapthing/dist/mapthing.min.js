/*! mapthing 2016-02-14 */

function createIcon(a,b){return L.icon({iconUrl:"mapthing/img/ffa500-marker-32.png",iconSize:[32,32],iconAnchor:[1,16],popupAnchor:[16,0]})}function showModal(a){$("#"+a).modal("show")}function initMap(){function a(){$(".leaflet-control-layers").css("max-height",$("#map").height()-50)}$.LoadingOverlaySetup({color:"rgba(255,255,255,0.8)",image:"mapthing/img/big_roller.gif",maxSize:"40px"}),$('[data-toggle="tooltip"]').tooltip({container:"body"});var b=new MT.MapController;MT._registerMap(b),$(window).resize(function(){a()}),$("#db-submit").click(function(){var a=$("#host").val(),c=$("#port").val(),d=$("#user").val(),e=$("#pwd").val(),f=new MT.DataLayer(b);f.jcalf(a,c,d,e)}),MT.Dom.addFileOpenHandler("open-file","file-path"),$("#choose-file").click(function(){BRIDGE.connectToPathField(document.getElementById("choose-file-path")),BRIDGE.showSaveFileDialog()}),$("#csv-submit").click(function(){var a=$("#file-path").text();new MT.CsvLayer(b,a)}),$("#print-submit").click(function(){var a=$("#choose-file-path").text();BRIDGE.printRequest(a)}),$("#overlay-submit").click(function(){b.addWmsOverlay()}),$("#geocode-submit").click(function(){b.geocode($("#address").val())}),$("#tour-btn").click(MT.runTour),$(".selectpicker").selectpicker(),$("#wms-host-select").on("change",function(a){MT.Dom.showLoading("#sb-overlays");var b=$(this).find("option:selected").val();$("#wms-layer-select").find("option").remove(),MT.Wms.capabilities(b,function(a){var b=$(a).find("Layer");b.each(function(a,b){var c='<option value="'+$(this).children("Name").text()+'">'+$(this).children("Title").text()+"</option>";$("#wms-layer-select").append(c)}),$("#wms-layer-select").selectpicker("refresh"),MT.Dom.hideLoading("#sb-overlays")})})}function getColor(a){return a>.8?"#7f2704":a>.7?"#a63603":a>.6?"#d94801":a>.5?"#f16913":a>.4?"#fd8d3c":a>.3?"#fdae6b":a>.2?"#fdd0a2":a>.1?"#fee6ce":"#fff5eb"}function default_style(a){return{fillColor:getColor(a.properties.scaling),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}var MT=MT||{};MT._load_config=function(a,b){$.ajax({url:a,cache:!0,success:function(a){b(a)}})},MT.Wms={capabilities:function(a,b){a+=-1===a.indexOf("?")?"?":"&",$.ajax({type:"GET",headers:{"Access-Control-Allow-Credentials":!0},xhrFields:{withCredentials:!0},url:a+"request=GetCapabilities&service=wms",dataType:"xml",success:function(a){b(a)},error:function(){MT.Dom.hideLoading("#sb-overlays"),MT.Dom.showMessage("Could not connect")}})},createLegend:function(a){var b=function(a){var b=$(a).find('ServiceException[code="LayerNotDefined"]');b&&console.log(b[0]),MT.Dom.showMessage("No legend is available for this layer:\n"+b[0].textContent,"WMS does not provide legend")},c=function(b,c,d){"parsererror"===c?e[f]=L.wmsLegend(g,a._map):(console.log(c),console.log(d),MT.Dom.showMessage(d.message,"Error creating legend"))},d=a.getLegendGraphic(),e={};for(var f in d){var g=d[f];$.ajax({type:"GET",url:g,dataType:"xml",success:b,error:c})}return e}},MT._registerMap=function(a){MT._mCtrl=a},MT.getMap=function(){return MT._mCtrl},MT.MapController=function(a){"undefined"==typeof a&&(a="map"),this.overLays={},this.jcalfLayers=[];var b=L.tileLayer("https://api.mapbox.com/v4/ianmillinship.8850fe41/{z}/{x}/{y}.png256?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"}),c=L.tileLayer("https://api.mapbox.com/v4/mapbox.satellite/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"}),d=L.tileLayer("https://api.mapbox.com/v4/mapbox.streets-satellite/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"}),e=L.tileLayer("http://os.openstreetmap.org/sv/{z}/{x}/{y}.png",{attribution:"Contains Ordnance Survey Data Â© Crown copyright and database right 2010"});this.geocoder=new google.maps.Geocoder,this._map=L.map(a,{zoom:13,center:[53.952612,-2.090103],layers:[b],zoomControl:!1,attributionControl:!0,loadingControl:!0}),this.zoomControl=L.control.zoom({position:"bottomright"}).addTo(this._map);var f={"JBA RML":b,Satellite:c,"Satellite (streets)":d,"OS Streetview":e};this.sidebar=L.control.sidebar("sidebar").addTo(this._map),this.layerControl=L.control.layerpanel(f,this.overLays,"sb-layers").addTo(this._map),this.searchControl=new L.Control.Search({sourceData:this.googleGeocoding.bind(this),formatData:this.formatJSON.bind(this),markerLocation:!1,circleLocation:!1,autoType:!1,autoCollapse:!0,position:"bottomright",minLength:2,zoom:10}),this._map.addControl(this.searchControl)},MT.MapController.prototype.showSidebarTab=function(a){this.sidebar.open(a)},MT.MapController.prototype.closeSidebarTab=function(a){this.sidebar.close(a)},MT.MapController.prototype.disable=function(){this._map.scrollWheelZoom.disable(),this._map.dragging.disable(),this._map.touchZoom.disable(),this._map.doubleClickZoom.disable(),this._map.boxZoom.disable(),this._map.keyboard.disable()},MT.MapController.prototype.enable=function(){this._map.scrollWheelZoom.enable(),this._map.dragging.enable(),this._map.touchZoom.enable(),this._map.doubleClickZoom.enable(),this._map.boxZoom.enable(),this._map.keyboard.enable()},MT.MapController.prototype.addWmsOverlay=function(a,b,c,d,e){"undefined"==typeof a&&(a=$("#wms-host-select").val()),"undefined"==typeof b&&(b=$("#wms-layer-select").val()),"undefined"==typeof c&&(c=$("#wms-layer-select").find("option:selected").text()),"undefined"==typeof d&&(d="image/png"),"undefined"==typeof e&&$("wms-host-select").text().indexOf("JBA")>-1&&(e="&copy 2015 JBA Risk Management Ltd");var f=L.tileLayer.wms(a,{maxZoom:30,layers:b,format:d,transparent:!0,version:"1.1.0",attribution:e});this.overLays[c]=f,this._map.addLayer(f),this.layerControl.addOverlay(f,c)},MT.MapController.prototype.addOverlay=function(a,b){this._map.addLayer(a),this.layerControl.addOverlay(a,b)},MT.MapController.prototype.removeOverlay=function(a){this._map.removeLayer(this.overLays[a])},MT.MapController.prototype.googleGeocoding=function(a,b){this.geocoder.geocode({address:a},b)},MT.MapController.prototype.formatJSON=function(a){var b,c={},d=[];for(var e in a)b=a[e].formatted_address,d=L.latLng(a[e].geometry.location.lat(),a[e].geometry.location.lng()),c[b]=d;return c},MT.PluginGui=function(){this._elements=[]},MT.PluginGui.prototype.sidebarPanel=function(a){var b=MT.Dom._makeSidebarPanel(a.title,a.id+"-panel");this._elements.push(a.id+"-panel"),b.append(a.content),a.pane=b[0],MT.Dom._addSidebarPanel(a)},MT.PluginGui.prototype.modal=function(a){},MT.PluginGui.prototype.modeless=function(a){},MT.PluginGui.prototype.close=function(){for(var a=0;a<this._elements.length;a++)$("#"+this._elements[a]).remove()},MT.Dom={showMessage:function(a,b){bootbox.dialog({message:a,title:b,buttons:{main:{label:"Ok",className:"btn-primary"}}})},_makeSidebarPanel:function(a,b){var c=$("<div>",{"class":"sidebar-pane",id:b}),d=$("<h1>",{"class":"sidebar-header",html:a+'<div class="sidebar-close"><i class="fa fa-caret-left"></i></div>'});return c.append(d),c},_addSidebarPanel:function(a){MT._mCtrl.sidebar.addPanel(a)},hideSidebar:function(){$("#sidebar").hide()},showSidebar:function(){$("#sidebar").show()},prepareMapForPrint:function(){this.hideSidebar();var a=MT.getMap();a.zoomControl.remove(),a.searchControl.remove()},resetMapAfterPrint:function(){this.showSidebar();var a=MT.getMap();a.zoomControl.addTo(a._map),a.searchControl.addTo(a._map)},showLoading:function(a){$(a).LoadingOverlay("show")},hideLoading:function(a){$(a).LoadingOverlay("hide")},makePluginSidebarUi:function(a){var b=$("#sb-plugin-header").html();MT.header=b,$("#sb-plugin-header").html(a+'<div class="sidebar-close"><i class="fa fa-caret-left"></i></div>');var c=$("#sb-plugin-area"),d=c.contents();d.detach();var e=$("<button/>",{text:"Exit",id:"plugin-exit-btn","class":"btn btn-default",click:function(){c.empty(),c.append(d),$("#sb-plugin-header").html(b)}}),f=$("<hr>");return c.append(e),c.append(f),c},makeModalWindow:function(a,b){var c=$("#modalWindow");return c.find(".modal-title").text(a),c.find(".modal-body").html(b),c.modal(),c},addPluginLauncher:function(a,b,c){for(var d=a+"Launch",e=b.split("."),f=0,g=e.length,h=window;g>f;++f)h=h[e[f]];var i=$("<button/>",{text:a,"class":"btn btn-default",id:d,click:function(){h()}});i.tooltip({placement:"right",title:c}),$("#sb-plugin-area").append(i)},addFileOpenForm:function(a){var b=a+"-open-file-btn",c=a+"-file-path-span",d=$("<form/>",{"class":"csv-form"}),e=$("<div/>",{"class":"form-group"}),f=$("<label/>",{"for":b,text:"Load file"}),g=$("<div/>",{"class":"input-group"}),h=$("<span/>",{"class":"input-group-btn"}),i=$("<button/>",{"class":"btn btn-default",type:"button",id:b,text:"Browse...",click:function(){console.log(b+" was clicked"),BRIDGE.connectToPathField(document.getElementById(c)),BRIDGE.showOpenFileDialog()}}),j=$("<span/>",{"class":"form-control",id:c});return h.append(i),g.append(h),g.append(j),e.append(f),e.append(g),d.append(e),d},addFileOpenHandler:function(a,b){console.log("file open handler "+a),$("#"+a).click(function(){console.log(a+" was clicked"),BRIDGE.connectToPathField(document.getElementById(b)),BRIDGE.showOpenFileDialog()})}},MT.tour=new Tour({backdrop:!1,steps:[{orphan:!0,title:"Welcome!",content:"MapThing is a visual showcase and integration platform for JBA RML data and tools. This short tour is intended to get you familiar with the user interface.",onShow:function(a){MT.getMap().closeSidebarTab("sb-help")}},{element:"#container",placement:"top",title:"The Map",content:"It's all about the map. The key idea behind MapThing is simplicity. As such the main focus of the core program is on visualisation and generating images. It allows you to quickly navigate the map, add overlays from web services and print images. Plugins can extend the functionality of MapThing to create new overlays from different sources, charts and provide more complex analysis of JBA data. "},{element:".sidebar",title:"Sidebar",content:"Clicking on a sidebar button will display a panel for the selected feature. Hovering over buttons will popup a short description."},{element:"#sb-btn-layers",title:"Display the layer control",content:"MapThing offers a rudimentary layer control. "},{element:"#sb-layers",title:"Layers Control",content:"Switch between a selection of basemap layers and show/hide or remove overlays which have been added to the map",onShow:function(a){MT.getMap().showSidebarTab("sb-layers")},onHide:function(a){MT.getMap().closeSidebarTab("sb-layers")}},{element:"#sb-btn-overlays",title:"WMS Overlays",content:"MapThing is pre-configured to connect to a few WMS' suitable for JBA RML needs in order to quickly add overlays. Lets expand the tab and see what is available"},{element:"#wms-host-select",title:"Select a host",content:"Select a web service from the drop down list. Environment Agency & FEMA WMS' are available. JBA RML's own service for hazard map data will be available in the near future",onShow:function(a){MT.getMap().showSidebarTab("sb-overlays")}},{element:"#wms-layer-select",title:"Select a layer",content:"Once a host has been selected, this dropdown will populate with the available layers. You can browse through or search for a desired layer and select it"},{element:"#overlay-submit",title:"Add the layer",content:"Found a layer you want? Click this button to add it to the map. It will appear in the layer control. Some WMS layers have legends. If a legend is available, it will be displayed and can be hidden/shown via the layer control",onHide:function(a){MT.getMap().closeSidebarTab("sb-overlays")}},{element:"#sb-btn-plugin",title:"Plugins",content:"MapThings' analysis functionality and integration with other JBA tools and methods comes from the extensible plugin framework Available plugins are displayed in this panel and can be enabled by clicking the corresponding button.The plugin possibilities are huge, so don't hesitate to get in touch with any wild and crazy ideas."},{element:"#sb-btn-print",title:"Print",content:"Print the map to a PNG image! The image is created at the current size and resolution of the window. The final image will not feature any GUI elements (such as the sidebar) and a JBA RML logo will be inserted into the top left corner."},{placement:"left",element:".leaflet-control-search",title:"Search for places",content:"A typeahead search which makes use of Googles' Geocoding API. Type in a placename or word to search for and it will search for matching places."},{placement:"left",element:".leaflet-control-zoom-in",title:"Zoom",content:"No mouse wheel? No worries. Use these buttons to zoom in and out. You can also zoom with the +/- keys and navigate with the arrow keys."}]}),MT.runTour=function(){MT.tour.init(),MT.tour.start()},MT.BubbleLayer=function(a){this._layer=L.geoJson(),this.name=a},MT.BubbleLayer.prototype.addBubble=function(a,b,c,d){var e=L.circle([a,b],1e4*d),f=e.toGeoJson();f.properties.value=c,f.properties.scaling=scaledTiv,this._layer.addData(f)},MT.BubbleLayer.prototype.addToMap=function(a){"undefined"==typeof a&&(a=default_style),this._layer.setStyle(a);var b=MT.getMap();b.addOverlay(this._layer,this.layerName)},MT.DataLayer=function(a){this.mapCt=a,this.layerName="unknown"},MT.DataLayer.prototype.jcalf=function(a,b,c,d){this.host=a,this.port=b,this.user=c,this.pwd=d,this.layerName="JCalf: "+a,this.lastUpdate=+new Date},MT.DataLayer.prototype.remove=function(){delete this.clusterLayer},MT.DataLayer.prototype.maybeCreateLayer=function(a){if(a===!0){console.log("Setting up layer");this.clusterLayer=new PruneClusterForLeaflet,this.mapCt.addOverlay(this.clusterLayer,this.layerName),this.update()}else MT.Dom.showMessage("Unknown error","Unable to connect to the database")},MT.DataLayer.prototype.processView=function(){$("#map").trigger("dataloading"),this.clusterLayer.ProcessView(),$("#map").trigger("dataload"),$("#disable-overlay").hide(),this.mapCt.enable()},MT.DataLayer.prototype.update=function(){if(this.mapCt._map.hasLayer(this.clusterLayer)){$("#disable-overlay").show(),this.mapCt.disable();this.mapCt._map.getBounds();this.clusterLayer.RemoveMarkers()}},MT.DataLayer.prototype.addRiskMarker=function(a,b,c){var d=new PruneCluster.Marker(a,b);d.data.icon=createIcon,d.data.tiv=c,this.clusterLayer.RegisterMarker(d)},MT.DataLayer.prototype.addClusterSizeWidget=function(){$('<div href="#" id="size">Cluster size: <input type="range" value="160" min="35" max="500" step="1" id="sizeInput"><span id="currentSize">112</span></div>').insertAfter("#map"),$("#sizeInput").onChange=this.updateSize.bind(this),$("#sizeInput").onChange=this.updateSize.bind(this)},MT.DataLayer.prototype.updateSize=function(){var a=$("#sizeInput").val();this.clusterLayer.Cluster.Size=parseInt(a),$("#currentSize").firstChild.data=a;var b=+new Date;b-this.lastUpdate<400||(this.clusterLayer.ProcessView(),this.lastUpdate=b)},MT.DataLayer.prototype.showLoadingStats=function(a,b){bootbox.dialog({message:a+" markers were loaded, "+b+" rows were skipped (did not contain lat or long values)",title:"Loading finished",buttons:{main:{label:"Ok",className:"btn-primary"}}})},MT.CsvLayer=function(a,b){this.mapCt=b,this.layerName="unknown",this.layerName=a,this.createLayer(!0)},MT.CsvLayer.prototype=new MT.DataLayer,MT.CsvLayer.prototype.constructor=MT.CsvLayer,MT.CsvLayer.prototype.addToMap=function(){this.mapCt.addOverlay(this.clusterLayer,this.layerName)},MT.CsvLayer.prototype.createLayer=function(a){this.clusterLayer=new PruneClusterForLeaflet},L.Control.LayerPanel=L.Control.Layers.extend({options:{collapsed:!1,autoZIndex:!1},initialize:function(a,b,c,d){this._container=L.DomUtil.get(c),L.Control.Layers.prototype.initialize.call(this,a,b,d)},_initLayout:function(){var a="leaflet-panel-layers",b=this._container,c=this._form=L.DomUtil.create("form",a+"-list");this._baseLayersList=L.DomUtil.create("div",a+"-base",c),this._separator=L.DomUtil.create("div",a+"-separator",c),this._overlaysList=L.DomUtil.create("div",a+"-overlays",c),b.appendChild(c)},addTo:function(a){return this.remove(),this._map=a,this._container=this.onAdd(a),this},_onLegendClick:function(a){var b=this._layers[a].layer;if("undefined"==typeof b.legendObjs)b.legendObjs=MT.Wms.createLegend(b);else for(var c in b.legendObjs){var d=b.legendObjs[c];console.log(d),d.container.hidden===!1?(console.log("Hide Control"),d.container.hidden=!0,d.container.style.visibility="hidden",console.log(d.container.isActive)):(console.log("Show Control"),d.container.hidden=!1,d.container.style.visibility="visible")}},_onDeleteClick:function(a){if(layer=this._layers[a].layer,"undefined"!=typeof layer.legendObjs)for(var b in layer.legendObjs)layer._map.removeControl(layer.legendObjs[b]);this._map.removeLayer(layer),this.removeLayer(layer),layer.remove()},_addItem:function(a){var b,c,d,e,f,g=document.createElement("label"),h=this._map.hasLayer(a.layer),i=document.createElement("div");if(i.className="row row-layer-control",e=document.createElement("div"),e.className="pull-left",f=document.createElement("div"),f.className="pull-right",a.overlay){b=document.createElement("input"),b.className="leaflet-control-layers-selector",b.type="checkbox",b.defaultChecked=h;var j="btn btn-secondary btn-layer-control";c=document.createElement("a"),c.className=j;var k=document.createElement("i");k.className="fa fa-list-ul",c.setAttribute("data-placement","left"),c.setAttribute("data-toggle","tooltip"),c.setAttribute("title","Add the layer's legend to the map (if available)"),c.appendChild(k),d=document.createElement("a"),d.className=j,d.setAttribute("data-placement","left"),d.setAttribute("data-toggle","tooltip"),d.setAttribute("title","Delete layer");var l=document.createElement("i");l.className="fa fa-trash",d.appendChild(l),f.appendChild(c),f.appendChild(d),L.DomEvent.on(c,"click",function(){this._onLegendClick(b.layerId)},this),L.DomEvent.on(d,"click",function(){this._onDeleteClick(b.layerId)},this)}else b=this._createRadioElement("leaflet-base-layers",h);b.layerId=L.stamp(a.layer),L.DomEvent.on(b,"click",this._onInputClick,this);var m=document.createElement("span");m.innerHTML=" "+a.name,g.appendChild(b),g.appendChild(m),e.appendChild(g),i.appendChild(e),i.appendChild(f);var n=a.overlay?this._overlaysList:this._baseLayersList;return n.appendChild(i),this._checkDisabledLayers(),i},_checkDisabledLayers:function(){for(var a,b,c=this._form.getElementsByTagName("input"),d=this._map.getZoom(),e=c.length-1;e>=0;e--)a=c[e],b=this._layers[a.layerId].layer,a.disabled=void 0!==b.options.minZoom&&d<b.options.minZoom||void 0!==b.options.maxZoom&&d>b.options.maxZoom},_expand:function(){},_collapse:function(){}}),L.control.layerpanel=function(a,b,c,d){return new L.Control.LayerPanel(a,b,c,d)},L.Control.WMSLegend=L.Control.extend({options:{position:"topright",uri:""},onAdd:function(){var a="leaflet-control-wms-legend",b="wms-legend",c=L.DomEvent.stopPropagation;return this.container=L.DomUtil.create("div",a),this.container.id=this.options.uri,this.img=L.DomUtil.create("img",b,this.container),this.img.src=this.options.uri,this.img.alt="Legend",L.DomEvent.on(this.img,"click",this._click,this).on(this.container,"click",this._click,this).on(this.img,"mousedown",c).on(this.img,"dblclick",c).on(this.img,"click",L.DomEvent.preventDefault).on(this.img,"click",c),this.height=null,this.width=null,this.container},_click:function(a){L.DomEvent.stopPropagation(a),L.DomEvent.preventDefault(a);var b=window.getComputedStyle(this.img);"none"===b.display?(this.container.style.height=this.height+"px",this.container.style.width=this.width+"px",this.img.style.display=this.displayStyle):(null===this.width&&null===this.height&&(this.height=this.container.offsetHeight,this.width=this.container.offsetWidth),this.displayStyle=this.img.style.display,this.img.style.display="none",this.container.style.height="20px",this.container.style.width="20px")}}),L.wmsLegend=function(a,b){var c=new L.Control.WMSLegend;return c.options.uri=a,b.addControl(c),c};
//# sourceMappingURL=mapthing.min.js.map