function createIcon(data,category){return L.icon({iconUrl:"mapthing/img/ffa500-marker-32.png",iconSize:[32,32],iconAnchor:[1,16],popupAnchor:[16,0]})}function showModal(id){$("#"+id).modal("show")}function initMap(){function sizeLayerControl(){$(".leaflet-control-layers").css("max-height",$("#map").height()-50)}$('[data-toggle="tooltip"]').tooltip();var mapCtrl=new MT.MapController;MT._registerMap(mapCtrl),$(window).resize(function(){sizeLayerControl()}),$("#db-submit").click(function(){var host=$("#host").val(),port=$("#port").val(),user=$("#user").val(),pwd=$("#pwd").val(),jcalflyr=new MT.DataLayer(mapCtrl);jcalflyr.jcalf(host,port,user,pwd)}),$("#open-file").click(function(){BRIDGE.connectToPathField(document.getElementById("file-path")),BRIDGE.showOpenFileDialog()}),$("#choose-file").click(function(){BRIDGE.connectToPathField(document.getElementById("choose-file-path")),BRIDGE.showSaveFileDialog()}),$("#csv-submit").click(function(){var path=$("#file-path").text();new MT.CsvLayer(mapCtrl,path)}),$("#print-submit").click(function(){var path=$("#choose-file-path").text();console.log(path),BRIDGE.printRequest(path)}),$("#overlay-submit").click(function(){console.log("overlay submit"),mapCtrl.addWmsOverlay()}),$("#geocode-submit").click(function(){mapCtrl.geocode($("#address").val())}),$("#summarize-view-btn").click(function(){$("#lecModal").on("shown.bs.modal",function(event){getResultsForRisksInView()}).on("hidden.bs.modal",function(event){var modal=$(this),canvas=modal.find(".modal-body canvas");canvas.attr("width","568px").attr("height","300px"),lecChart.clear(),lecChart.destroy(),$(this).data("bs.modal",null)}),showModal("lecModal")})}var MT=MT||{};MT._registerMap=function(mapCtrl){MT._mCtrl=mapCtrl},MT.getMap=function(){return MT._mCtrl},MT.MapController=function(id){"undefined"==typeof id&&(id="map"),this.overLays={},this.jcalfLayers=[];var jbaBasemap=L.tileLayer("https://api.mapbox.com/v4/ianmillinship.8850fe41/{z}/{x}/{y}.png256?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"}),satBasemap=L.tileLayer("https://api.mapbox.com/v4/mapbox.satellite/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"}),streetSatBasemap=L.tileLayer("https://api.mapbox.com/v4/mapbox.streets-satellite/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"});this.geocoder=new google.maps.Geocoder,this._map=L.map(id,{zoom:13,center:[53.952612,-2.090103],layers:[jbaBasemap],zoomControl:!1,attributionControl:!0,loadingControl:!0}),this.zoomControl=L.control.zoom({position:"bottomright"}).addTo(this._map);var baseLayers={"jba-rml":jbaBasemap,satellite:satBasemap,"streets-satellite":streetSatBasemap};this.sidebar=L.control.sidebar("sidebar").addTo(this._map),this.layerControl=L.control.layerpanel(baseLayers,this.overLays,"sb-layers").addTo(this._map),this.searchControl=new L.Control.Search({sourceData:this.googleGeocoding.bind(this),formatData:this.formatJSON.bind(this),markerLocation:!1,circleLocation:!1,autoType:!1,autoCollapse:!0,position:"bottomright",minLength:2,zoom:10}),this._map.addControl(this.searchControl)},MT.MapController.prototype.disable=function(){this._map.scrollWheelZoom.disable(),this._map.dragging.disable(),this._map.touchZoom.disable(),this._map.doubleClickZoom.disable(),this._map.boxZoom.disable(),this._map.keyboard.disable()},MT.MapController.prototype.enable=function(){this._map.scrollWheelZoom.enable(),this._map.dragging.enable(),this._map.touchZoom.enable(),this._map.doubleClickZoom.enable(),this._map.boxZoom.enable(),this._map.keyboard.enable()},MT.MapController.prototype.addWmsOverlay=function(host,layerName,format){"undefined"==typeof host&&(host=$("#hazardmaphost").val()),"undefined"==typeof layerName&&(layerName=$("#layer").val()),"undefined"==typeof format&&(format=$("#format").val());var displayName,layer=L.tileLayer.wms(host,{maxZoom:30,layers:layerName,format:format,transparent:!0,version:"1.1.0",attribution:"&copy 2015 JBA Risk Management Ltd"}),layerNameParts=layerName.split(":");displayName=2===layerNameParts.length?layerNameParts[1]:layerName,this.overLays[displayName]=layer,this._map.addLayer(layer),this.layerControl.addOverlay(layer,displayName)},MT.MapController.prototype.addOverlay=function(layer,name){this._map.addLayer(layer),this.layerControl.addOverlay(layer,name)},MT.MapController.prototype.removeOverlay=function(displayName){this._map.removeLayer(this.overLays[displayName])},MT.MapController.prototype.googleGeocoding=function(text,callResponse){this.geocoder.geocode({address:text},callResponse)},MT.MapController.prototype.formatJSON=function(rawjson){var key,loc,json={};for(var i in rawjson)key=rawjson[i].formatted_address,loc=L.latLng(rawjson[i].geometry.location.lat(),rawjson[i].geometry.location.lng()),json[key]=loc;return json},MT.showMessage=function(msg,title){bootbox.dialog({message:msg,title:title,buttons:{main:{label:"Ok",className:"btn-primary"}}})};var MT=MT||{};MT.DataLayer=function(mapCt){this.mapCt=mapCt,this.layerName="unknown"},MT.DataLayer.prototype.jcalf=function(host,port,user,pwd){this.host=host,this.port=port,this.user=user,this.pwd=pwd,this.layerName="JCalf: "+host,this.lastUpdate=+new Date,BRIDGE.databaseConnected.connect(this.maybeCreateLayer.bind(this)),BRIDGE.error.connect(MT.showMessage),BRIDGE.connectDatabase(host,port,user,pwd)},MT.DataLayer.prototype.remove=function(){delete this.clusterLayer},MT.DataLayer.prototype.maybeCreateLayer=function(status){if(status===!0){console.log("Setting up layer"),BRIDGE.exposureUpdated.connect(this.addRiskMarker.bind(this)),BRIDGE.workFinished.connect(this.processView.bind(this));this.clusterLayer=new PruneClusterForLeaflet,this.mapCt.addOverlay(this.clusterLayer,this.layerName),this.update()}else MT.showMessage("Unknown error","Unable to connect to the database")},MT.DataLayer.prototype.processView=function(){$("#map").trigger("dataloading"),this.clusterLayer.ProcessView(),$("#map").trigger("dataload"),$("#disable-overlay").hide(),this.mapCt.enable()},MT.DataLayer.prototype.update=function(){if(this.mapCt._map.hasLayer(this.clusterLayer)){$("#disable-overlay").show(),this.mapCt.disable();var bounds=this.mapCt._map.getBounds();this.clusterLayer.RemoveMarkers(),BRIDGE.refreshExposures(bounds.getWest(),bounds.getSouth(),bounds.getEast(),bounds.getNorth())}},MT.DataLayer.prototype.addRiskMarker=function(lat,lon,tiv){var marker=new PruneCluster.Marker(lat,lon);marker.data.icon=createIcon,marker.data.tiv=tiv,this.clusterLayer.RegisterMarker(marker)},MT.DataLayer.prototype.addClusterSizeWidget=function(){$('<div href="#" id="size">Cluster size: <input type="range" value="160" min="35" max="500" step="1" id="sizeInput"><span id="currentSize">112</span></div>').insertAfter("#map"),$("#sizeInput").onChange=this.updateSize.bind(this),$("#sizeInput").onChange=this.updateSize.bind(this)},MT.DataLayer.prototype.updateSize=function(){var newSize=$("#sizeInput").val();this.clusterLayer.Cluster.Size=parseInt(newSize),$("#currentSize").firstChild.data=newSize;var now=+new Date;now-this.lastUpdate<400||(this.clusterLayer.ProcessView(),this.lastUpdate=now)},MT.DataLayer.prototype.showLoadingStats=function(loaded,skipped){bootbox.dialog({message:loaded+" markers were loaded, "+skipped+" rows were skipped (did not contain lat or long values)",title:"Loading finished",buttons:{main:{label:"Ok",className:"btn-primary"}}})},MT.CsvLayer=function(mapCt,path){this.mapCt=mapCt,this.layerName="unknown",this.layerName=path.split("\\").pop().split("/").pop(),console.log(this.layerName),this.createLayer(!0),BRIDGE.loadFile()},MT.CsvLayer.prototype=new MT.DataLayer,MT.CsvLayer.prototype.constructor=MT.CsvLayer,MT.CsvLayer.prototype.createLayer=function(status){BRIDGE.exposureUpdated.connect(this.addRiskMarker.bind(this)),BRIDGE.workFinished.connect(this.processView.bind(this)),BRIDGE.markerLoadingStats.connect(this.showLoadingStats.bind(this)),this.clusterLayer=new PruneClusterForLeaflet,this.mapCt.addOverlay(this.clusterLayer,this.layerName)},L.Control.LayerPanel=L.Control.Layers.extend({options:{collapsed:!1,autoZIndex:!1},initialize:function(baseLayers,overlays,id,options){this._container=L.DomUtil.get(id),L.Control.Layers.prototype.initialize.call(this,baseLayers,overlays,options)},_initLayout:function(){var className="leaflet-panel-layers",container=this._container,form=this._form=L.DomUtil.create("form",className+"-list");this._baseLayersList=L.DomUtil.create("div",className+"-base",form),this._separator=L.DomUtil.create("div",className+"-separator",form),this._overlaysList=L.DomUtil.create("div",className+"-overlays",form),container.appendChild(form)},addTo:function(map){this.remove(),this._map=map;this._container=this.onAdd(map);return this},_createOverlayControl:function(obj){document.createElement("div")},_onExpandClick:function(layerId){console.log("Expand click"),layer=this._layers[layerId].layer,console.log(layer),console.log(layer.Cluster.ComputeBounds()),console.log(layer.getBounds())},_onDeleteClick:function(layerId){layer=this._layers[layerId].layer,this._map.removeLayer(layer),this.removeLayer(layer),layer.remove&&layer.remove(),delete layer},_addItem:function(obj){var input,expandBtn,deleteBtn,pullLeft,pullRight,label=document.createElement("label"),checked=this._map.hasLayer(obj.layer),holder=document.createElement("div");if(holder.className="row row-layer-control",pullLeft=document.createElement("div"),pullLeft.className="pull-left",pullRight=document.createElement("div"),pullRight.className="pull-right",obj.overlay){input=document.createElement("input"),input.className="leaflet-control-layers-selector",input.type="checkbox",input.defaultChecked=checked;var buttonClass="btn btn-secondary btn-layer-control";expandBtn=document.createElement("a"),expandBtn.className=buttonClass;var expandIcon=document.createElement("i");expandIcon.className="fa fa-arrows-alt",expandBtn.appendChild(expandIcon),deleteBtn=document.createElement("a"),deleteBtn.className=buttonClass;var deletIcon=document.createElement("i");deletIcon.className="fa fa-trash",deleteBtn.appendChild(deletIcon),pullRight.appendChild(expandBtn),pullRight.appendChild(deleteBtn),L.DomEvent.on(expandBtn,"click",function(){this._onExpandClick(input.layerId)},this),L.DomEvent.on(deleteBtn,"click",function(){this._onDeleteClick(input.layerId)},this)}else input=this._createRadioElement("leaflet-base-layers",checked);input.layerId=L.stamp(obj.layer),L.DomEvent.on(input,"click",this._onInputClick,this);var name=document.createElement("span");name.innerHTML=" "+obj.name,label.appendChild(input),label.appendChild(name),pullLeft.appendChild(label),holder.appendChild(pullLeft),holder.appendChild(pullRight);var container=obj.overlay?this._overlaysList:this._baseLayersList;return container.appendChild(holder),this._checkDisabledLayers(),holder},_checkDisabledLayers:function(){for(var input,layer,inputs=this._form.getElementsByTagName("input"),zoom=this._map.getZoom(),i=inputs.length-1;i>=0;i--)input=inputs[i],layer=this._layers[input.layerId].layer,input.disabled=void 0!==layer.options.minZoom&&zoom<layer.options.minZoom||void 0!==layer.options.maxZoom&&zoom>layer.options.maxZoom},_expand:function(){},_collapse:function(){}}),L.control.layerpanel=function(baseLayers,overlays,id,options){return new L.Control.LayerPanel(baseLayers,overlays,id,options)};var MT=MT||{};MT.Dom={hideSidebar:function(){$("#sidebar").hide()},showSidebar:function(){$("#sidebar").show()},prepareMapForPrint:function(){this.hideSidebar();var mc=MT.getMap();mc.zoomControl.remove(),mc.searchControl.remove()},resetMapAfterPrint:function(){this.showSidebar();var mc=MT.getMap();mc.zoomControl.addTo(mc._map),mc.searchControl.addTo(mc._map)},makePluginSidebarUi:function(name){var header=$("#sb-plugin-header").html();MT.header=header,$("#sb-plugin-header").html(name+'<div class="sidebar-close"><i class="fa fa-caret-left"></i></div>');var uiArea=$("#sb-plugin-area"),originalState=uiArea.contents();originalState.detach();var exitBtn=$("<button/>",{text:"Exit",id:"plugin-exit-btn",class:"btn btn-default",click:function(){uiArea.empty(),uiArea.append(originalState),$("#sb-plugin-header").html(header)}}),hr=$("<hr>");return uiArea.append(exitBtn),uiArea.append(hr),uiArea},addPluginLauncher:function(pluginName,setupFunc,description){for(var id=pluginName+"Launch",parts=setupFunc.split("."),i=0,len=parts.length,obj=window;len>i;++i)obj=obj[parts[i]];var button=$("<button/>",{text:pluginName,class:"btn btn-default",id:id,click:function(){obj()}});button.tooltip({placement:"right",title:description}),$("#sb-plugin-area").append(button)}};