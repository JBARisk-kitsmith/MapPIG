function createIcon(data,category){return L.icon({iconUrl:"mapthing/img/ffa500-marker-32.png",iconSize:[32,32],iconAnchor:[1,16],popupAnchor:[16,0]})}function showModal(id){$("#"+id).modal("show")}function initMap(){function sizeLayerControl(){$(".leaflet-control-layers").css("max-height",$("#map").height()-50)}$('[data-toggle="tooltip"]').tooltip();var mapCtrl=new MT.MapController;MT._registerMap(mapCtrl),$(window).resize(function(){sizeLayerControl()}),$("#db-submit").click(function(){var host=$("#host").val(),port=$("#port").val(),user=$("#user").val(),pwd=$("#pwd").val(),jcalflyr=new MT.DataLayer(mapCtrl);jcalflyr.jcalf(host,port,user,pwd)}),MT.Dom.addFileOpenHandler("open-file","file-path"),$("#choose-file").click(function(){BRIDGE.connectToPathField(document.getElementById("choose-file-path")),BRIDGE.showSaveFileDialog()}),$("#csv-submit").click(function(){var path=$("#file-path").text();new MT.CsvLayer(mapCtrl,path)}),$("#print-submit").click(function(){var path=$("#choose-file-path").text();BRIDGE.printRequest(path)}),$("#overlay-submit").click(function(){mapCtrl.addWmsOverlay()}),$("#geocode-submit").click(function(){mapCtrl.geocode($("#address").val())}),$("#summarize-view-btn").click(function(){$("#lecModal").on("shown.bs.modal",function(event){getResultsForRisksInView()}).on("hidden.bs.modal",function(event){var modal=$(this),canvas=modal.find(".modal-body canvas");canvas.attr("width","568px").attr("height","300px"),lecChart.clear(),lecChart.destroy(),$(this).data("bs.modal",null)}),showModal("lecModal")}),$(".selectpicker").selectpicker(),$("#wms-host-select").on("change",function(e){var url=$(this).find("option:selected").val();$("#wms-layer-select").find("option").remove(),MT.Wms.capabilities(url,function(xml){$(xml).find("Layer").each(function(){var option='<option value="'+$(this).children("Name").text()+'">'+$(this).children("Title").text()+"</option>";$("#wms-layer-select").append(option)}),$("#wms-layer-select").selectpicker("refresh")})})}function getColor(d){return d>.8?"#7f2704":d>.7?"#a63603":d>.6?"#d94801":d>.5?"#f16913":d>.4?"#fd8d3c":d>.3?"#fdae6b":d>.2?"#fdd0a2":d>.1?"#fee6ce":"#fff5eb"}function default_style(feature){return{fillColor:getColor(feature.properties.scaling),weight:2,opacity:1,color:"white",dashArray:"3",fillOpacity:.7}}var MT=MT||{};MT.Wms={capabilities:function(url,callback){url+=-1===url.indexOf("?")?"?":"&",$.ajax({type:"GET",url:url+"request=GetCapabilities&service=wms",dataType:"xml",success:function(xml){callback(xml)}})},createLegend:function(layer){var legends=layer.getLegendGraphic(),legendObjs=null;for(var name in legends){var url=legends[name];$.ajax({type:"GET",url:url,dataType:"xml",success:function(xml){var result=$(xml).find('ServiceException[code="LayerNotDefined"]');result&&console.log(result[0]),MT.showMessage("No legend is available for this layer:\n"+result[0].textContent,"WMS does not provide legend")},error:function(xhr,status,error){"parererror"===status?(void 0===legendObjs&&(legendObjs={}),legendObjs[name]=L.wmsLegend(url,layer._map)):(console.log(status),console.log(error),MT.showMessage(error,"Error creating legend"))}})}return legendObjs}},MT._registerMap=function(mapCtrl){MT._mCtrl=mapCtrl},MT.getMap=function(){return MT._mCtrl},MT.MapController=function(id){"undefined"==typeof id&&(id="map"),this.overLays={},this.jcalfLayers=[];var jbaBasemap=L.tileLayer("https://api.mapbox.com/v4/ianmillinship.8850fe41/{z}/{x}/{y}.png256?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"}),satBasemap=L.tileLayer("https://api.mapbox.com/v4/mapbox.satellite/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"}),streetSatBasemap=L.tileLayer("https://api.mapbox.com/v4/mapbox.streets-satellite/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiaWFubWlsbGluc2hpcCIsImEiOiJjaWg0eWx6OGwwMHVua3JrcjU1ZnA4bjFlIn0.mcnkt1qUDw7cH0cmhxcZ8w",{attribution:"&copy; <a href='https://www.mapbox.com/about/maps/'>Mapbox</a> &copy; <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a>"});this.geocoder=new google.maps.Geocoder,this._map=L.map(id,{zoom:13,center:[53.952612,-2.090103],layers:[jbaBasemap],zoomControl:!1,attributionControl:!0,loadingControl:!0}),this.zoomControl=L.control.zoom({position:"bottomright"}).addTo(this._map);var baseLayers={"jba-rml":jbaBasemap,satellite:satBasemap,"streets-satellite":streetSatBasemap};this.sidebar=L.control.sidebar("sidebar").addTo(this._map),this.layerControl=L.control.layerpanel(baseLayers,this.overLays,"sb-layers").addTo(this._map),this.searchControl=new L.Control.Search({sourceData:this.googleGeocoding.bind(this),formatData:this.formatJSON.bind(this),markerLocation:!1,circleLocation:!1,autoType:!1,autoCollapse:!0,position:"bottomright",minLength:2,zoom:10}),this._map.addControl(this.searchControl)},MT.MapController.prototype.disable=function(){this._map.scrollWheelZoom.disable(),this._map.dragging.disable(),this._map.touchZoom.disable(),this._map.doubleClickZoom.disable(),this._map.boxZoom.disable(),this._map.keyboard.disable()},MT.MapController.prototype.enable=function(){this._map.scrollWheelZoom.enable(),this._map.dragging.enable(),this._map.touchZoom.enable(),this._map.doubleClickZoom.enable(),this._map.boxZoom.enable(),this._map.keyboard.enable()},MT.MapController.prototype.addWmsOverlay=function(host,layerName,displayName,format,attr){"undefined"==typeof host&&(host=$("#wms-host-select").val()),"undefined"==typeof layerName&&(layerName=$("#wms-layer-select").val()),"undefined"==typeof displayName&&(displayName=$("#wms-layer-select").find("option:selected").text()),"undefined"==typeof format&&(format="image/png"),"undefined"==typeof attr&&(attr="&copy 2015 JBA Risk Management Ltd"),console.log(host),console.log(layerName);var layer=L.tileLayer.wms(host,{maxZoom:30,layers:layerName,format:format,transparent:!0,version:"1.1.0",attribution:attr});this.overLays[displayName]=layer,this._map.addLayer(layer),this.layerControl.addOverlay(layer,displayName)},MT.MapController.prototype.addOverlay=function(layer,name){this._map.addLayer(layer),this.layerControl.addOverlay(layer,name)},MT.MapController.prototype.removeOverlay=function(displayName){this._map.removeLayer(this.overLays[displayName])},MT.MapController.prototype.googleGeocoding=function(text,callResponse){this.geocoder.geocode({address:text},callResponse)},MT.MapController.prototype.formatJSON=function(rawjson){var key,loc,json={};for(var i in rawjson)key=rawjson[i].formatted_address,loc=L.latLng(rawjson[i].geometry.location.lat(),rawjson[i].geometry.location.lng()),json[key]=loc;return json},MT.showMessage=function(msg,title){bootbox.dialog({message:msg,title:title,buttons:{main:{label:"Ok",className:"btn-primary"}}})};var MT=MT||{};MT.DataLayer=function(mapCt){this.mapCt=mapCt,this.layerName="unknown"},MT.DataLayer.prototype.jcalf=function(host,port,user,pwd){this.host=host,this.port=port,this.user=user,this.pwd=pwd,this.layerName="JCalf: "+host,this.lastUpdate=+new Date,BRIDGE.databaseConnected.connect(this.maybeCreateLayer.bind(this)),BRIDGE.error.connect(MT.showMessage),BRIDGE.connectDatabase(host,port,user,pwd)},MT.DataLayer.prototype.remove=function(){delete this.clusterLayer},MT.DataLayer.prototype.maybeCreateLayer=function(status){if(status===!0){console.log("Setting up layer"),BRIDGE.exposureUpdated.connect(this.addRiskMarker.bind(this)),BRIDGE.workFinished.connect(this.processView.bind(this));this.clusterLayer=new PruneClusterForLeaflet,this.mapCt.addOverlay(this.clusterLayer,this.layerName),this.update()}else MT.showMessage("Unknown error","Unable to connect to the database")},MT.DataLayer.prototype.processView=function(){$("#map").trigger("dataloading"),this.clusterLayer.ProcessView(),$("#map").trigger("dataload"),$("#disable-overlay").hide(),this.mapCt.enable()},MT.DataLayer.prototype.update=function(){if(this.mapCt._map.hasLayer(this.clusterLayer)){$("#disable-overlay").show(),this.mapCt.disable();var bounds=this.mapCt._map.getBounds();this.clusterLayer.RemoveMarkers(),BRIDGE.refreshExposures(bounds.getWest(),bounds.getSouth(),bounds.getEast(),bounds.getNorth())}},MT.DataLayer.prototype.addRiskMarker=function(lat,lon,tiv){var marker=new PruneCluster.Marker(lat,lon);marker.data.icon=createIcon,marker.data.tiv=tiv,this.clusterLayer.RegisterMarker(marker)},MT.DataLayer.prototype.addClusterSizeWidget=function(){$('<div href="#" id="size">Cluster size: <input type="range" value="160" min="35" max="500" step="1" id="sizeInput"><span id="currentSize">112</span></div>').insertAfter("#map"),$("#sizeInput").onChange=this.updateSize.bind(this),$("#sizeInput").onChange=this.updateSize.bind(this)},MT.DataLayer.prototype.updateSize=function(){var newSize=$("#sizeInput").val();this.clusterLayer.Cluster.Size=parseInt(newSize),$("#currentSize").firstChild.data=newSize;var now=+new Date;now-this.lastUpdate<400||(this.clusterLayer.ProcessView(),this.lastUpdate=now)},MT.DataLayer.prototype.showLoadingStats=function(loaded,skipped){bootbox.dialog({message:loaded+" markers were loaded, "+skipped+" rows were skipped (did not contain lat or long values)",title:"Loading finished",buttons:{main:{label:"Ok",className:"btn-primary"}}})},MT.CsvLayer=function(mapCt,path){this.mapCt=mapCt,this.layerName="unknown",this.layerName=path.split("\\").pop().split("/").pop(),this.createLayer(!0),BRIDGE.loadFile()},MT.CsvLayer.prototype=new MT.DataLayer,MT.CsvLayer.prototype.constructor=MT.CsvLayer,MT.CsvLayer.prototype.createLayer=function(status){BRIDGE.exposureUpdated.connect(this.addRiskMarker.bind(this)),BRIDGE.workFinished.connect(this.processView.bind(this)),BRIDGE.markerLoadingStats.connect(this.showLoadingStats.bind(this)),this.clusterLayer=new PruneClusterForLeaflet,this.mapCt.addOverlay(this.clusterLayer,this.layerName)},L.Control.LayerPanel=L.Control.Layers.extend({options:{collapsed:!1,autoZIndex:!1},initialize:function(baseLayers,overlays,id,options){this._container=L.DomUtil.get(id),L.Control.Layers.prototype.initialize.call(this,baseLayers,overlays,options)},_initLayout:function(){var className="leaflet-panel-layers",container=this._container,form=this._form=L.DomUtil.create("form",className+"-list");this._baseLayersList=L.DomUtil.create("div",className+"-base",form),this._separator=L.DomUtil.create("div",className+"-separator",form),this._overlaysList=L.DomUtil.create("div",className+"-overlays",form),container.appendChild(form)},addTo:function(map){this.remove(),this._map=map;this._container=this.onAdd(map);return this},_createOverlayControl:function(obj){document.createElement("div")},_onLegendClick:function(layerId){var layer=this._layers[layerId].layer;if("undefined"==typeof layer.legendObjs)layer.legendObjs=MT.Wms.createLegend(layer);else{for(var name in layer.legendObjs)var control=layer.legendObjs[name];console.log(control),control.container.hidden===!1?(console.log("Hide Control"),control.container.hidden=!0,control.container.style.visibility="hidden",console.log(control.container.isActive)):(console.log("Show Control"),control.container.hidden=!1,control.container.style.visibility="visible")}},_onDeleteClick:function(layerId){if(layer=this._layers[layerId].layer,"undefined"!=typeof layer.legendObjs)for(var name in layer.legendObjs)layer._map.removeControl(layer.legendObjs[name]);this._map.removeLayer(layer),this.removeLayer(layer),layer.remove&&layer.remove(),delete layer},_addItem:function(obj){var input,legendBtn,deleteBtn,pullLeft,pullRight,label=document.createElement("label"),checked=this._map.hasLayer(obj.layer),holder=document.createElement("div");if(holder.className="row row-layer-control",pullLeft=document.createElement("div"),pullLeft.className="pull-left",pullRight=document.createElement("div"),pullRight.className="pull-right",obj.overlay){input=document.createElement("input"),input.className="leaflet-control-layers-selector",input.type="checkbox",input.defaultChecked=checked;var buttonClass="btn btn-secondary btn-layer-control";legendBtn=document.createElement("a"),legendBtn.className=buttonClass;var legendIcon=document.createElement("i");legendIcon.className="fa fa-list-ul",legendBtn.appendChild(legendIcon),deleteBtn=document.createElement("a"),deleteBtn.className=buttonClass;var deletIcon=document.createElement("i");deletIcon.className="fa fa-trash",deleteBtn.appendChild(deletIcon),pullRight.appendChild(legendBtn),pullRight.appendChild(deleteBtn),L.DomEvent.on(legendBtn,"click",function(){this._onLegendClick(input.layerId)},this),L.DomEvent.on(deleteBtn,"click",function(){this._onDeleteClick(input.layerId)},this)}else input=this._createRadioElement("leaflet-base-layers",checked);input.layerId=L.stamp(obj.layer),L.DomEvent.on(input,"click",this._onInputClick,this);var name=document.createElement("span");name.innerHTML=" "+obj.name,label.appendChild(input),label.appendChild(name),pullLeft.appendChild(label),holder.appendChild(pullLeft),holder.appendChild(pullRight);var container=obj.overlay?this._overlaysList:this._baseLayersList;return container.appendChild(holder),this._checkDisabledLayers(),holder},_checkDisabledLayers:function(){for(var input,layer,inputs=this._form.getElementsByTagName("input"),zoom=this._map.getZoom(),i=inputs.length-1;i>=0;i--)input=inputs[i],layer=this._layers[input.layerId].layer,input.disabled=void 0!==layer.options.minZoom&&zoom<layer.options.minZoom||void 0!==layer.options.maxZoom&&zoom>layer.options.maxZoom},_expand:function(){},_collapse:function(){}}),L.control.layerpanel=function(baseLayers,overlays,id,options){return new L.Control.LayerPanel(baseLayers,overlays,id,options)};var MT=MT||{};MT.Dom={hideSidebar:function(){$("#sidebar").hide()},showSidebar:function(){$("#sidebar").show()},prepareMapForPrint:function(){this.hideSidebar();var mc=MT.getMap();mc.zoomControl.remove(),mc.searchControl.remove()},resetMapAfterPrint:function(){this.showSidebar();var mc=MT.getMap();mc.zoomControl.addTo(mc._map),mc.searchControl.addTo(mc._map)},makePluginSidebarUi:function(name){var header=$("#sb-plugin-header").html();MT.header=header,$("#sb-plugin-header").html(name+'<div class="sidebar-close"><i class="fa fa-caret-left"></i></div>');var uiArea=$("#sb-plugin-area"),originalState=uiArea.contents();originalState.detach();var exitBtn=$("<button/>",{text:"Exit",id:"plugin-exit-btn",class:"btn btn-default",click:function(){uiArea.empty(),uiArea.append(originalState),$("#sb-plugin-header").html(header)}}),hr=$("<hr>");return uiArea.append(exitBtn),uiArea.append(hr),uiArea},addPluginLauncher:function(pluginName,setupFunc,description){for(var id=pluginName+"Launch",parts=setupFunc.split("."),i=0,len=parts.length,obj=window;len>i;++i)obj=obj[parts[i]];var button=$("<button/>",{text:pluginName,class:"btn btn-default",id:id,click:function(){obj()}});button.tooltip({placement:"right",title:description}),$("#sb-plugin-area").append(button)},addFileOpenHandler:function(buttonId,inputId){$(document.getElementById(buttonId)).click(function(){BRIDGE.connectToPathField(document.getElementById(inputId)),BRIDGE.showOpenFileDialog()})}};var MT=MT||{};MT.BubbleLayer=function(layerName){this._layer=L.geoJson(),this.name=layerName},MT.BubbleLayer.prototype.addBubble=function(x,y,value,scaledValue){var circle=L.circle([x,y],1e4*scaledValue),circleJson=circle.toGeoJson();circleJson.properties.value=value,circleJson.properties.scaling=scaledTiv,this._layer.addData(circleJson)},MT.BubbleLayer.prototype.addToMap=function(styleFn){"undefined"==typeof styleFn&&(styleFn=default_style),this._layer.setStyle(styleFn);var mapCtrl=MT.getMap();mapCtrl.addOverlay(this._layer,this.layerName)},L.Control.WMSLegend=L.Control.extend({options:{position:"topright",uri:""},onAdd:function(){var controlClassName="leaflet-control-wms-legend",legendClassName="wms-legend",stop=L.DomEvent.stopPropagation;return this.container=L.DomUtil.create("div",controlClassName),this.container.id=this.options.uri,this.img=L.DomUtil.create("img",legendClassName,this.container),this.img.src=this.options.uri,this.img.alt="Legend",L.DomEvent.on(this.img,"click",this._click,this).on(this.container,"click",this._click,this).on(this.img,"mousedown",stop).on(this.img,"dblclick",stop).on(this.img,"click",L.DomEvent.preventDefault).on(this.img,"click",stop),this.height=null,this.width=null,this.container},_click:function(e){L.DomEvent.stopPropagation(e),L.DomEvent.preventDefault(e);var style=window.getComputedStyle(this.img);"none"===style.display?(this.container.style.height=this.height+"px",this.container.style.width=this.width+"px",this.img.style.display=this.displayStyle):(null===this.width&&null===this.height&&(this.height=this.container.offsetHeight,this.width=this.container.offsetWidth),this.displayStyle=this.img.style.display,this.img.style.display="none",this.container.style.height="20px",this.container.style.width="20px")}}),L.wmsLegend=function(uri,map){var wmsLegendControl=new L.Control.WMSLegend;return wmsLegendControl.options.uri=uri,map.addControl(wmsLegendControl),wmsLegendControl};